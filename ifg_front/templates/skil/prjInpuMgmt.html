<!--  ********************************************
grid sample
history
    - 2020.08 김은희 최초작성
*********************************************** -->
{% extends 'common/base.html' %}

{% block content %}
<style>
#modal {
  display:none;
  position:relative;
  width:100%;
  height:100%;
  z-index:1;
}

#modal h2 {
  margin:0;
}

#modal input {
  border: 0;
  border-bottom: 1px solid #0489B1;
  outline : 0;
}

#modal .popup {
  width:1000px;
  margin:100px auto;
  padding:0px 40px;
  background:#fff;
  border:2px solid #666;
}

.modal_layer {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgb(0, 0, 0, 0.5);
  z-index:-1;
}

</style>

<script type="text/javascript">
    var firstGrid;

    $(document).ready(function(){
        document.getElementById("modal").style.display="block";
        firstGrid = $('[data-ax5grid="first-grid"]');
        getGridList(1);

        /* 임시조회 버튼(삭제예정) */
        $('#searchBtn').click(function(){
            getGridList(1);
        });
            function getGridList(page){
                $('#formSearchDiv').ajaxCall({
                    method : 'GET',
                    url : "{% url 'skil_api:prjInpuSearch' %}",
                    callbackFn : function(data){

                        var gridList = data; /* 그리드에 세팅할 데이터는 JSON 배열 형태 */

                        var gridOptions = {
                            columns: [              /* columns : 그리드 헤더 및 매핑 시킬 컬럼 및 컬럼 속성 설정 항목(필수) */
                                { key: "EMP_NO",        label: "성명",          width: 100, align: "center", editor: {type: "text"} },
                                { key: "PRJ_CD",        label: "소속구분(수정)", width: 80,  align: "center", editor: {type: "text"} },
                                { key: "SKIL_GRADE",    label: "스킬등급(수정)", width: 80,  align: "center", editor: {type: "text"} },
                                { key: "DIVS",          label: "구분",          width: 80,  align: "center", editor: {type: "text"} },
                                { key: "SLIN_GRD",      label: "매출등급",      width: 80,  align: "center", editor: {type: "text"} },
                                { key: "INPU_STRT_DAY", label: "투입시작일",    width: 80,  align: "center", editor: {type: "date"} },
                                { key: "INPU_END_DAY",  label: "투입종료일",    width: 80,  align: "center", editor: {type: "date"} },
                                { key: "CNTC_STRT_DAY", label: "계약시작일",    width: 80,  align: "center", editor: {type: "date"} },
                                { key: "CNTC_END_DAY",  label: "계약종료일",    width: 80,  align: "center", editor: {type: "date"} },
                                { key: "CRGE_JOB",      label: "담당업무",      width: 80,  align: "center", editor: {type: "text"} },
                                { key: "RMKS",          label: "비고",          width: 80,  align: "center", editor: {type: "text"} },
                                { key: "STUS",          label: "상태",          width: 80,  align: "center", hidden : true}
                            ]
                        };
                        firstGrid = $('[data-ax5grid="first-grid"]');
                        firstGrid = firstGrid.initGrid(gridOptions);
                        firstGrid.setData(gridList);
                    }
                });
            }

            /* 행 추가 버튼 */
            $('#grpAddBtn').click(function(){
                firstGrid.addRow({EMP_NO: '',PRJ_CD : '',SKIL_GRADE: '',DIVS: '',SLIN_GRD: '',INPU_STRT_DAY: '',INPU_END_DAY: '',CNTC_STRT_DAY: '',CNTC_END_DAY: '',CRGE_JOB: '',RMKS :'',STUS :'insert'});
            });

            /* 행 삭제 버튼 */
            $('#grpDelBtn').click(function(){

                if(firstGrid.getList("selected").length == 0){
                    alertMsg("선택된 행이 없습니다.");
                    return false;
                }
                confirmMsg('삭제 하시겠습니까?', function(){
                    if(firstGrid.getList("selected")[0].STUS !="insert"){
                        var delList = firstGrid.getList('selected')[0];
                        $.ajaxCall(delList, {
                            url : '{% url 'skil_api:prjInpuDelete' %}',
                            method : 'post',
                            callbackFn : function(data){
                                g_toast.push('삭제 되었습니다.');
                            }
                        });
                    }
                    firstGrid.deleteRow(firstGrid.selectedDataIndexs[0]); //선택한 행 삭제
                });
            });

             /* 팝업 취소 버튼 (수정필요.)*/
            document.getElementById("closeBtn").onclick = function() {
                history.back()
            }

            /* 개발자 추가 버튼 */
           $('#devpAddBtn').click(function(){

                /* 행 선택됐는지 체크 */
                if(firstGrid.getList("selected").length == 0){
                    alertMsg("선택된 행이 없습니다.");
                    return;
                }
                /* 해당 row에 이미 값이 존재 하는 지 체크 */
                if(firstGrid.getList("selected")[0].EMP_NO  != ""){
                    alertMsg("해당 Row는 이미 개발자가 존재합니다.");
                    return;
                }
                var empNo = 100 /* 사번 임시 값(수정필요.)*/
                /* 해당 프로젝트에 이미 존재하는 개발자인지 체크 */
                var list = firstGrid.getList()
                for(var i = 0; i < list.length; i++){
                    if(list[i].EMP_NO == empNo){
                       alertMsg("이미 해당 프로젝트에 존재하는 개발자입니다.");
                       return;
                    }
                }
                /* 다른컬럼도 넣어주기 INPU_END_DAY = "" 이런식으로 안그러면 null처리됨... */
                firstGrid.updateRow({EMP_NO: empNo, PRJ_CD: 100, SKIL_GRADE: '상', DIVS: '정규직', SLIN_GRD: '', INPU_STRT_DAY: '', INPU_END_DAY: '', CNTC_STRT_DAY: '', CNTC_END_DAY: '', CRGE_JOB: '', RMKS: '', STUS :'insert', __created__ : true, __modified__ : true,}, firstGrid.selectedDataIndexs[0]); /* 다른화면에서 값 받아와야 됨(수정필요.)*/
            });

            /* 저장 버튼 */
           $('#savaBtn').click(function(){
                confirmMsg('저장 하시겠습니까?', function(){
                    var updateList = firstGrid.getList('modified');
                    var updateYN = firstGrid.getList('modified').length;
                    if( updateYN == 0 ){
                        alertMsg("수정 후 저장하세요.");
                        return;
                    }

                    /* 개발자 추가 여부 Validation 확인 */
                    var gridList = firstGrid.getList()
                    for(var i = 0; i < gridList.length; i++){
                        if(gridList[i].EMP_NO == ""){
                           alertMsg("["+(i+1)+"행] 개발자를 추가하세요.");
                           firstGrid.select(i);
                           return;
                        }
                    }
                    $.ajaxCall(updateList, {
                        url : '{% url 'skil_api:prjInpuSave' %}',
                        method : 'post',
                        callbackFn : function(data){
                            g_toast.push('저장 되었습니다.');
                            getGridList(1);
                        }
                    });
                });
           });

    });
</script>

    <style>

    </style>
    <div class="row" id="modal">
        <div class="col-sm-12" id = "popup" style="background : #fff;">
            <div id="formSearchDiv" style="padding-top :20px;">
                <h3>프로젝트 별 투입 현황 관리 <a href="http://ax5.io/ax5ui-grid/api/index.html" class="badge badge-info"></a></h3>
                <div id="formDiv">
                    <div class="bs-example" data-example-id="simple-table">
                        <table class="table table-bordered">
                          <tbody>
                            <tr>
                              <th scope="row" style="width:20%">프로젝트 명</th>
                              <td style="width:30%">1111</td>
                              <th scope="row" style="width:20%">계약코드</th>
                              <td style="width:30%"><input type="email" name="prjCd" placeholder="계약코드 입력 ex)1111" maxlength="70"/></td>
                            </tr>
                            <tr>
                              <th scope="row">업무구분</th>
                              <td>SI</td>
                              <th scope="row">프로젝트 계약기간</th>
                              <td>2020-07-01 ~ 2020-09-30</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                </div>
            </div>
            <hr>
            <div>
                <h4>투입 인력 조회<a class="badge badge-info"></a>
                <div style="float: right;">
                    <button class="btn btn-primary btn-sm" id="grpAddBtn"> + </button>
                    <button class="btn btn-primary btn-sm" id="grpDelBtn"> - </button>
                </div>
                </h4>

                <div style="position: relative;height:510px;">
                    <div id="projectGrid" data-ax5grid="first-grid" style="height: 90%;"/>
                </div>
                <div style="float: right; float: right; padding-top :5px;" id="btn">
                    <button class="btn btn-primary" id="submitBtn1">업로드 양식 다운</button>
                    <button class="btn btn-primary" id="submitBtn2">개발자 일괄 업로드</button>
                    <button class="btn btn-primary" id="devpAddBtn">개발자 추가</button>
                    <button class="btn btn-primary" id="savaBtn">저장</button>
                    <button class="btn btn-primary" id="searchBtn">임시 조회</button>
                    <button class="btn btn-primary" id="closeBtn">닫기</button>
                </div>
            </div>
        </div>

        <div class="modal_layer"></div>
    </div>

{% endblock %}